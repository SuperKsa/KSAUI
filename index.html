<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="ksaui.js"></script>
    <!--
    <script src="./data/vue.js"></script>
    -->
</head>
<body>
<style>
    div { background: rgba(0,0,0,.2); padding: 20px; color: #fff; margin: 5px;}
</style>
<template id="vue-template">
    <table>
        <tr><th>姓名</th><td>{{name}}</td></tr>
        <tr><th>性别</th><td>{{sex}}</td></tr>
        <tr><th>学校</th><td>{{school}}</td></tr>
        <tr><th>电话</th><td>{{tel}}</td></tr>
    </table>
    ###
    <!-- {{name}} -->
{{name =='张三' ? '输出张三' : sex}}
    <div>
    <template v-for="(value,key) in list">
        <template v-if="value.name != '张三1'">
            <div>{{key}} : {{value.name}} {{value.sex}} {{name}}</div>
        </template>
        <template v-else-if="value.name == '张三10'">
            <div>【elseif】 {{value.name}}</div>
        </template>
        <template v-else>
            <div>【else】</div>
        </template>
    </template>
    </div>
</template>

<div id="vuedom" style="display: none"></div>


<script>

    var LOOPMAX = 1;

    var sdt = {
        name : '二大爷',
        sex : '男',
        school :'江山中学',
        tel :'18888888888',
        list : {
            0 : {name : '张二娃', sex : '男'},

            1 : {name : '李老五', sex : '男'},
            2 : {name : '王同学', sex : '男'},
            99 : {name : '梅老坎99', sex : '男'},
            data : {
                name : '附加list',
                sex : '性别NO',
                list : {
                    'a1' : '男1',
                    'a2' : '男2',
                }
            }
        }
    };
</script>
<script>


    (function(){return;
        Vue.config.devtools = false;
        Vue.config.productionTip = false;
        var template = $('#vue-template').html();
        var pushDOM = $('#vuedom');

        for(var i =0; i<LOOPMAX; i++){
            (function(){
                var dom = $.dom('<div>'+template.replace('###',i)+'</div>');
                pushDOM.append(dom);
            })();
        }
        console.time("VUE");
        var VUE = new Vue({el : '#vuedom', data : sdt});
        debug(VUE);
        console.timeEnd("VUE");
    })();

</script>

<template id="template">

    <table class="as">
        <tr><th>姓名</th><td>${name}</td></tr>
        <tr><th>性别</th><td>${sex}</td></tr>
        <tr><th>学校</th><td>${school}</td></tr>
        <tr><th>电话</th><td>${tel}</td></tr>
    </table>
<!-- ${name} -->
    ${window.location.href}
    ${name =='1' ? 'name1' : (name === 3 ? 3 : sdt.sex)}
    <div>
        {loop list key value}
        {eval}
        var evaladd = {a:('123'+key)};
        {/eval}



        {if value.name != '张二娃' && value.name !='张三10'}
        <div>${key} : ${value.name} ${value.sex} /
            {if name =='123'}
            ${name}
            {/if}
        </div>
        {elseif value.name =='张三10'}
        <div>【elseif】 ${value.name}</div>
        {else}
        <div>【else】</div>
        {/if}
        {/loop}
    </div>
</template>

<div id="mvvm"></div>
<div class="a" cid="v" data-da="1"></div>
<div class="a" cid="v" data-da="2"></div>
<textarea>
    ${value . name ? value[1].name.toString('(1.)\'value.ame测试12+23') : (value.sex ? '一' : (value.n[10] +1))}
    ${key} : ${value.name} ${value.sex} ${name}
    ${list[1].name.toString()}
    ${window.location.href}
    ${list[1][2].name[1].name }
    ${a}
    ${list.name[0].name32[120]}
</textarea>
<script>
    var KTPL;
    (function(){
        var template = $('#template').html();
        var pushDOM = $('#mvvm');

        for(var i =0; i<LOOPMAX; i++){
            (function(){
                var dom = $.dom(template);
                pushDOM.append(dom);
            })();
        }
        console.time('KSA');
        KTPL = pushDOM.tpl(sdt);
        console.timeEnd('KSA');
    })();
    debug(KTPL);


/*
    //eval性能测试
    (function(){
        var NMAX = 1000;
        var code = [];
        for(var i =0; i<NMAX; i++){
            code.push(' "<p>姓名："+sdt.name+"</p><p>性别："+sdt.sex+"</p>" ');
        }
        code = code.join('+');
        console.time('test1');
        eval(code);
        console.timeEnd('test1');

        console.time('test2');
        for(var i =0; i<NMAX; i++){
            eval(' "<p>姓名："+sdt.name+"</p><p>性别："+sdt.sex+"</p>" ');
        }
        console.timeEnd('test2');


    })();
*/


    /*
        console.time("timer");
        var AS = KSA('#mvvm').tpl(sdt);
        console.timeEnd("timer");
        */

    /*
    function AST(exp) {
        var inSingle = false;
        var inDouble = false;
        var inTemplateString = false;
        var inRegex = false;
        var curly = 0;
        var square = 0;
        var paren = 0;
        var lastFilterIndex = 0;
        var c, prev, i, expression, filters;

        for (i = 0; i < exp.length; i++) {
            prev = c;
            c = exp.charCodeAt(i);
            if (inSingle) {
                if (c === 0x27 && prev !== 0x5C) { inSingle = false; }
            } else if (inDouble) {
                if (c === 0x22 && prev !== 0x5C) { inDouble = false; }
            } else if (inTemplateString) {
                if (c === 0x60 && prev !== 0x5C) { inTemplateString = false; }
            } else if (inRegex) {
                if (c === 0x2f && prev !== 0x5C) { inRegex = false; }
            } else if (
                c === 0x7C && // pipe
                exp.charCodeAt(i + 1) !== 0x7C &&
                exp.charCodeAt(i - 1) !== 0x7C &&
                !curly && !square && !paren
            ) {
                if (expression === undefined) {
                    // first filter, end of expression
                    lastFilterIndex = i + 1;
                    expression = exp.slice(0, i).trim();
                } else {
                    pushFilter();
                }
            } else {
                switch (c) {
                    case 0x22: inDouble = true; break         // "
                    case 0x27: inSingle = true; break         // '
                    case 0x60: inTemplateString = true; break // `
                    case 0x28: paren++; break                 // (
                    case 0x29: paren--; break                 // )
                    case 0x5B: square++; break                // [
                    case 0x5D: square--; break                // ]
                    case 0x7B: curly++; break                 // {
                    case 0x7D: curly--; break                 // }
                }
                if (c === 0x2f) { // /
                    var j = i - 1;
                    var p = (void 0);
                    // find first non-whitespace prev char
                    for (; j >= 0; j--) {
                        p = exp.charAt(j);
                        if (p !== ' ') { break }
                    }
                    if (!p || !validDivisionCharRE.test(p)) {
                        inRegex = true;
                    }
                }
            }
        }

        if (expression === undefined) {
            expression = exp.slice(0, i).trim();
        } else if (lastFilterIndex !== 0) {
            pushFilter();
        }

        function pushFilter () {
            (filters || (filters = [])).push(exp.slice(lastFilterIndex, i).trim());
            lastFilterIndex = i + 1;
        }

        if (filters) {
            for (i = 0; i < filters.length; i++) {
                expression = wrapFilter(expression, filters[i]);
            }
        }

        return expression
    }
    */
    //提取if条件中所有的变量名
    var code = $('textarea').val();

    var codeDt = [];

    /**
     * 匹配变量名
     * 第一位为字母、$、_、汉字
     */
    var varsRegx = /^([\u4e00-\u9fa5_a-zA-Z$]+([\u4e00-\u9fa5_a-zA-Z0-9$]+)?(((\[[0-9]+\])+|(\.[\u4e00-\u9fa5_a-zA-Z$][\u4e00-\u9fa5_a-zA-Z$0-9]+))+)?)(\.(charAt|charCodeAt|concat|fromCharCode|indexOf|includes|lastIndexOf|match|repeat|replace|search|slice|split|startsWith|substr|substring|toLowerCase|toUpperCase|trim|toLocaleLowerCase|toLocaleUpperCase|valueOf|toString|anchor|big|blink|bold|fixed|fontcolor|fontsize|italics|link|small|strike|sub|sup)\(.*?\))?$/g;
    code.replace(/\$\{((?:.|\r?\n)+?)\}/g, function(){
        var s = arguments[1];
        s = s.trim();
        //去掉字符串 去掉转义引号' " 去掉引号中间的内容 去掉.()[]左右空格
        s = s.replace(/\\'|\\"/g,'').replace(/("|')[^"']+("|')/g,'$1$2').replace(/\s+([\.\(\)\[\]\:\?])[\s+]?/g,'$1');
        s.replace(varsRegx, function(){
            if(arguments && arguments[1]){
                codeDt.push(arguments[1]);
            }
        });


    });

    /*
    code = code.split("\n");
    var codedt = {};
    $.loop(code, function(i, val){
        val = val.trim();
        if(val && !$.inArray(val,['(',')','()','""',"''"]) && !$.isNumber(val)){
            codedt[val] = val;
        }
    });
    debug(codedt);
    */
    //end

/*
//获取被触发的函数名
    var abc = {
        name : 123
    };
    Object.defineProperty(abc, 'name', {
        enumerable: true,
        configurable: true,
        set : function(v){
        },
        get : function(v){
            debug(new Error());
            //debug(new Error().stack.split("\n")[2].trim().split(" ")[4]);
            return v;
        }
    });
    var xx = ' (function(){return abc.name})() ';
    function a(){
        debug(new Error().stack);
        //debug((new Error()).stack.split("\n")[2].trim().split(" ")[1]);
    }
    function ifelseEvel(){
        eval('('+xx+')');
    }
    ifelseEvel();

    (function () {
        return ;
        var obj = {};

        function nodeContainer(node, vm, flag){
            var flag = flag || document.createDocumentFragment();

            var child;
            while(child = node.firstChild){
                compile(child, vm);
                flag.appendChild(child);
                if(child.firstChild){
                    nodeContainer(child, vm, flag);
                }
            }
            return flag;
        }

        //编译
        function compile(node, vm){
            var reg = /\{\{(.*)\}\}/g;
            if(node.nodeType === 1){
                var attr = node.attributes;
                //解析节点的属性
                for(var i = 0;i < attr.length; i++){
                    if(attr[i].nodeName == 'v-model'){

                        var name = attr[i].nodeValue;
                        node.addEventListener('input',function(e){
                            vm[name] = e.target.value;
                        });

                        node.value = vm[name];//讲实例中的data数据赋值给节点
                        node.removeAttribute('v-model');
                    }
                }
            }
            //如果节点类型为text
            if(node.nodeType === 3){

                if(reg.test(node.nodeValue)){
                    // console.dir(node);
                    var name = RegExp.$1;//获取匹配到的字符串
                    name = name.trim();
                    // node.nodeValue = vm[name];
                    new Watcher(vm,node,name);
                }
            }
        }

        function defineReactive (obj, key, value){
            var dep = new Dep();
            Object.defineProperty(obj,key,{
                get:function(){
                    console.log(Dep.global);
                    if(Dep.global){
                        dep.add(Dep.global);
                    }
                    console.log("get了值"+value);
                    return value;
                },
                set:function(newValue){
                    if(newValue === value){
                        return;
                    }
                    value = newValue;
                    console.log("set了最新值"+value);
                    dep.notify();
                }
            })
        }

        function observe (obj,vm){
            Object.keys(obj).forEach(function(key){
                defineReactive(vm,key,obj[key]);
            })
        }

        function Vue(options){
            this.data = options.data;
            var data = this.data;
            observe(data,this);
            var id = options.el;
            var dom = nodeContainer(document.getElementById(id),this);
            document.getElementById(id).appendChild(dom);
        }

        function Dep(){
            this.subs = [];
        }
        Dep.prototype ={
            add:function(sub){
                this.subs.push(sub);
            },
            notify:function(){
                this.subs.forEach(function(sub){
                    console.log(sub);
                    sub.update();
                })
            }
        }


        function Watcher(vm,node,name){
            Dep.global = this;
            this.name = name;
            this.node = node;
            this.vm = vm;
            this.update();
            Dep.global = null;
        }

        Watcher.prototype = {
            update:function(){
                this.get();
                switch (this.node.nodeType) {
                    case 1:
                        this.node.value = this.value;
                        break;
                    case 3:
                        this.node.nodeValue = this.value;
                        break;
                    default: break;
                }
            },
            get:function(){
                this.value = this.vm[this.name];
            }
        }


        var Demo = new Vue({
            el:'mvvm',
            data:{
                text:'HelloWorld',
                d:'123'
            }
        })
    })();
    /*
    var x = $('body').find('.inputs select').nextAll();
    console.dir(x);*/
    /*
    KSA.ajax({
        url : 'https://shop.ksaos.com/index/index/test',
        contentType : 'get',
        dataType : 'JSON',
        data : {
            zhangsan : '张三'
        },
        success : function(s){
            console.dir(s);
        }
    });

    KSA('.a').on('click', '.xx', function(e){
        console.dir(this.innerHTML);
    });
    KSA('.xx3').on('click', function(e){
        return false;
    });


var XX = KSA('.b').after('<i>new1</i><span>new2</span>').click(function(){
    console.dir(this);
});


var XX = KSA('.b').attr('aa cc','12').removeAttr('cc').data({'aa':123}).data('aa');

console.dir(XX);
*/

</script>
</body>
</html>